# TLS协议与加密

加密类型『非对称加密（公钥加密）、对称加密』

- ### 对称加密- >

   只有一个密钥，所有通信方都使用相同的密钥进行加密和解密；

- ### 非对称/公钥加密-> 

  有两个密钥：一个用于加密一个用于解密，任何用公钥加密的内容都只能用*私钥*解密。

  因此，一个服务器如果解密了用公钥加密的信息，就证明它拥有私钥。任何人都可以通过查看域或服务器的 TLS 证书来查看公钥。

  公钥加密是 TLS的基础技术，同时对于Web通过 HTTPS建立安全通行很有用。网站公开共享的SSL/TLS证书里面包含公钥，而私钥一般在源服务器上，从网站上获取不到。

  

> ### 加密、身份验证、HTTPS三合一 --> SSL/TLS证书
>
> SSL/TLS证书能让网站从HTTP转化为更安全的HTTPS，本质上是一个**数据文件**，托管在网站源服务器上。
>
> 证书含有网站的公钥和网站标识等信息。尝试和服务器通信的设备会引用证书，来获取公钥并验证服务器的身份（私钥妥善保管）
>
> > **SSL/TLS 证书**包含以下信息：
> >
> > - 针对其颁发证书的域名
> > - 证书颁发给哪一个人、组织或设备
> > - 证书由哪一证书颁发机构颁发
> > - 证书颁发机构的数字签名
> > - 关联的子域
> > - 证书的颁发日期
> > - 证书的到期日期
> > - 公钥（私钥为保密状态）



### TLS握手

1. **客户端hello**

   开始握手。client向server发送其支持的TLS版本、支持的密码套件、一串随机字节（client random）

2. **服务器hello**

   发送对客户端的回复，包括：server的SSL证书、server选择的密码套件、以及server生成的另一串随机字节（server random）

3. **身份验证**

   客户端使用*颁发该证书的证书颁发机构（**CA**）*验证服务器的 SSL 证书。此举确认服务器是其声称的身份，且客户端正在与该域的实际所有者进行交互。

4. **预主密钥** 

   客户端再发送一串随机字节，即“预主密钥（premaster secret）”。预主密钥是使用公钥加密的，只能使用服务器的私钥解密。（客户端从服务器的 SSL 证书中获得公钥）

5. **私钥被使用**

   服务器对预主密钥进行解密

6. **生成会话密钥**

   客户端和服务器均使用客户端随机数、服务器随机数和预主密钥生成会话密钥。双方应得到相同的结果。

7. **客户端就绪**

   客户端发送一条“已完成”消息，该消息用会话密钥加密

8. **服务器就绪**

   服务器发送一条“已完成”消息，该消息用会话密钥加密

9. **实现安全对称加密**

   完成握手，并使用会话密钥继续进行通信

> TLS握手达成连接，总的来说就是：
>
> 1. client连接到server
> 2. server出示其 TLS 证书
> 3. client验证server证书
> 4. client和server通过加密的 TLS 连接交换信息

TLS还对数据进行**数字签名**，以提供**数据完整性**，验证数据是否在到达目标接收者之前被篡改过。



### mTLS

相当于点对点的身份验证，通过验证它们都拥有正确的私人密钥，来确保网络连接两端的各方都是它们声称的身份。

mTLS常被用于零信任安全框架，也可以帮助保持API的安全。

相比于上面的TLS流程，mTLS中**client和server都有一个证书**，并且**双方都使用它们的公/私钥对进行身份验证**。与常规 TLS 相比，mTLS 中有一些额外步骤来验证双方：

> 1. client连接到server
> 2. server出示其 TLS 证书
> 3. client验证server证书
> 4. **客户端出示其 TLS 证书**
> 5. **服务器验证客户端的证书**
> 6. **服务器授予访问权限**
> 7. client和server通过加密的 TLS 连接交换信息

#### 关于mTLS的证书颁发机构（CA）

实施 mTLS 的组织充当其自己的证书颁发机构。这与标准 TLS 相反，标准 TLS 的证书颁发机构是一个外部组织，负责检查证书所有者是否合法。

mTLS 需要“**根”TLS 证书**；这使组织能够成为他们自己的证书颁发机构。授权客户端和服务器使用的证书必须与此根证书相对应。根证书是自签名的，这意味着组织自己创建它。

（这种方法不适用于公共互联网上的单向 TLS，因为必须由外部证书颁发机构颁发这些证书。对于公共互联网而言，将 TLS 证书分发到所有最终用户设备将非常困难。生成、管理和验证为此所需的数十亿证书几乎是不可能的任务。）



但在较小的规模上，mTLS 对单个组织非常实用，尤其是当这些组织采用零信任方法来确保网络安全时。组织必须能够在每次尝试访问网络中的任何时间对每个用户、设备和请求进行身份验证。mTLS 通过验证用户和验证设备来帮助实现这一点。