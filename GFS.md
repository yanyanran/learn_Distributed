# GFS分布式文件系统论文总结

## 单机文件系统  -->  分布式文件系统

1、文件被分割成固定大小的Chunk来存储  
2、自动扩缩容的实现主要通过在master单点上增减，调整chunk的元数据  
3、锁定文件存储在哪台机器上：根据master中文件到chunk再到chunk位置的映射，定位到具体的chunkServer  
4、为了保证服务器在故障时文件不丢失不损坏：实现master的WAL日志和主备，chunk的多副本  
5、使用多副本后保持副本之间的一致性：GFS区分改写和追加这两个不同的写入模式，在串行/并行情况下设计不同的一致性  

## 分布式文件系统  -->  GFS  

6、采用更大的chunk的配套的一致性策略来支持大文件的存储  
7、超多机器情况下实现自动监控、容错和恢复：master的主备切换由chubby（一致性，同raft）负责，chunk的租约、副本位置和数量由master负责  
8、支持快速的顺序读和追加写：三写一读，用流水线技术+数据流与控制流分离技术保证性能

## Main Point

### master设计

设计为单server节点，元数据包括：{1文件名和chunk空间，2文件和chunk的映射，3chunk到chunkServer的映射【不需要持久化】，4租约版本号（解决一致性问题）}
四个元数据里面只有【chunk副本】不需要做持久化，其他都需要存磁盘做持久化

> ***【chunk副本不需要做持久化的原因】***
>
> chunk启动chunkServer也要启动，master会扫描chunkServer，会扫描到对应的chunk，建立连接，加载数据到master中去。

### master容错

客户端发起操作会写到日志中去，master收到日志落盘后开始操作。发生错误后master重启，通过日志恢复。当日志量太大时为了快速启动，使用master定期快照。

### chunk的容错 -->  一致性

容错就靠chunk的三个副本【副本还可以负载均衡】，而一致性是通过chunk的校验码（唯一）【读写数据时判断数据是否有问题】和版本号【查看租约是否失效】

### 读文件
客户端发送file名，master通过file名和偏移量找到文件和chunkID的映射，master可以直接找到chunk地址返回给客户端，然后客户端选择最近的一个chunkServer读。

### 追加文件

客户端把要追加的文件名发送给master，然后master找到文件的最后一个chunk，接着master返回该chunk的租约和所有副本，假如chunk没有租约就创建租约【1】

> ***【1】***
>
> 租约本质其实就是为了减轻master压力，将权限发送给chunk让chunk执行。重新发放租约先更新租约版本号【一致性】，再负载均衡选择一个chunk发送租约。

客户端收到master返回的东西之后，给chunk流水线发送【就近】需要追加的数据，然后给主chunk发送控制流，等待主chunk执行完成后【保证一致性】再把控制流发送给其他副本chunk执行追加操作。

> ***【如果追加失败】***
>
> 其他副本chunk追加失败：主chunk重新发送追加数据和偏移量，进行重复追加，直到保证副本chunk全部在同一偏移量处追加成功【一致性】



